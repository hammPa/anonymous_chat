<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Chat Curhat Anonim</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">

  <h2 class="mb-3">ðŸ§± Tembok Curhat Mahasiswa</h2>
  <p id="online" class="text-muted"></p>

  <div class="card mb-4">
    <div class="card-body">
      <h5 class="card-title">Buat Post Baru</h5>
      <div class="input-group">
        <input id="judulPost" class="form-control" placeholder="Judul curhat..." />
        <button class="btn btn-primary" onclick="buatPost()">Buat</button>
      </div>
    </div>
  </div>

  <h5>Daftar Post</h5>
  <ul id="daftarPost" class="list-group"></ul>

</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io("http://localhost:3000");

const clientId =
  sessionStorage.getItem("client_id") || crypto.randomUUID();
sessionStorage.setItem("client_id", clientId);

socket.on("connect", () => {
  socket.emit("daftar_user", { client_id: clientId });
  socket.emit("ambil_daftar_post");
});

socket.on("user_online", d => {
  document.getElementById("online").innerText =
    "User online: " + d.jumlah;
});

function buatPost() {
  const judul = document.getElementById("judulPost").value.trim();
  if (!judul) return;
  socket.emit("buat_post", { judul });
}

socket.on("post_dibuat", (data) => {
  // redirect ke room
  window.location.href = `room.html?postId=${data.postId}&judul=${encodeURIComponent(data.judul)}`;
});

socket.on("daftar_post", (posts) => {
  const ul = document.getElementById("daftarPost");
  ul.innerHTML = "";

  posts.forEach(p => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex justify-content-between align-items-center";
    li.innerHTML = `
      <span>${p.judul} <small class="text-muted">(${p.pembuatAnonim})</small></span>
      <button class="btn btn-sm btn-outline-primary"
        onclick="masuk('${p._id}', '${encodeURIComponent(p.judul)}')">
        Masuk
      </button>
    `;
    ul.appendChild(li);
  });
});

function masuk(id, judul) {
  window.location.href = `room.html?postId=${id}&judul=${judul}`;
}
</script>

</body>
</html>
