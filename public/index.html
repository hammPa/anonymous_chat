<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Chat Curhat Anonim</title>
</head>
<body>

<h2>Chat Curhat Anonim</h2>

<p id="online"></p>
<div id="notifikasi" style="color: blue; font-style: italic;"></div>

<hr>

<h3>Buat Post</h3>
<input id="judulPost" placeholder="Judul post" />
<button onclick="buatPost()">Buat</button>

<h3>Daftar Post</h3>
<ul id="daftarPost"></ul>

<hr>

<h3 id="judulAktif">Belum masuk post</h3>
<button onclick="keluarPost()">Keluar Post</button>

<div id="kotakChat" style="border:1px solid #ccc; height:200px; overflow-y:auto;"></div>
<p id="indikatorMengetik" style="font-style:italic;color:gray;"></p>

<input id="inputPesan" placeholder="Tulis pesan..." />
<button onclick="kirim()">Kirim</button>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
/* ===== client id ===== */
const clientId =
  sessionStorage.getItem("client_id") || crypto.randomUUID();
sessionStorage.setItem("client_id", clientId);

/* ===== socket ===== */
const socket = io("http://localhost:3000");

/* ===== state ===== */
let postAktif = null;

/* ===== DOM ===== */
const kotakChat = document.getElementById("kotakChat");
const inputPesan = document.getElementById("inputPesan");
const indikator = document.getElementById("indikatorMengetik");
const notifikasi = document.getElementById("notifikasi");
const online = document.getElementById("online");
const daftarPostEl = document.getElementById("daftarPost");
const judulAktif = document.getElementById("judulAktif");

/* ===== identitas ===== */
socket.on("connect", () => {
  socket.emit("daftar_user", { client_id: clientId });
  socket.emit("ambil_daftar_post");
});

socket.on("identitas_user", (data) => {
  tampilkan(`Kamu adalah Anonim ${data.idAnonim}`);
});

/* ===== util ===== */
function tampilkan(teks) {
  const p = document.createElement("p");
  p.innerText = teks;
  kotakChat.appendChild(p);
  kotakChat.scrollTop = kotakChat.scrollHeight;
}

/* ===== post ===== */
function buatPost() {
  const judul = document.getElementById("judulPost").value;
  socket.emit("buat_post", { judul });
}

function masukPost(id, judul) {
  socket.emit("masuk_post", { postId: id });
  judulAktif.innerText = judul;
  kotakChat.innerHTML = "";
}

function keluarPost() {
  socket.emit("keluar_post");
  postAktif = null;
  judulAktif.innerText = "Belum masuk post";
  kotakChat.innerHTML = "";
}

socket.on("post_dibuat", (data) => {
  postAktif = data.postId;
  judulAktif.innerText = data.judul;
  kotakChat.innerHTML = "";
});

socket.on("berhasil_masuk_post", (data) => {
  postAktif = data.postId;
  judulAktif.innerText = data.judul;
  kotakChat.innerHTML = "";
});

socket.on("daftar_post", (posts) => {
  daftarPostEl.innerHTML = "";
  posts.forEach(p => {
    const li = document.createElement("li");
    li.innerHTML = `${p.judul} (${p.pembuat}) 
      <button onclick="masukPost('${p.id}', '${p.judul}')">Masuk</button>`;
    daftarPostEl.appendChild(li);
  });
});

/* ===== chat ===== */
function kirim() {
  if (!postAktif) {
    alert("Masuk post dulu!");
    return;
  }
  socket.emit("kirim_pesan", {
    postId: postAktif,
    isi_pesan: inputPesan.value
  });
  socket.emit("berhenti_mengetik", { postId: postAktif });
  inputPesan.value = "";
}

socket.on("pesan_baru", (data) => {
  tampilkan(`${data.dari}: ${data.isi}`);
});

/* ===== typing ===== */
let sedangMengetik = false;
let timeoutMengetik = null;

inputPesan.addEventListener("input", () => {
  if (!postAktif) return;

  if (!sedangMengetik) {
    sedangMengetik = true;
    socket.emit("mulai_mengetik", { postId: postAktif });
  }

  clearTimeout(timeoutMengetik);
  timeoutMengetik = setTimeout(() => {
    sedangMengetik = false;
    socket.emit("berhenti_mengetik", { postId: postAktif });
  }, 1000);
});

socket.on("user_mengetik", d => indikator.innerText = d.pesan);
socket.on("user_berhenti_mengetik", () => indikator.innerText = "");

/* ===== sistem ===== */
socket.on("user_online", d => online.innerText = "User online: " + d.jumlah);
socket.on("notifikasi_sistem", d => {
  notifikasi.innerText = d.pesan;
  setTimeout(() => notifikasi.innerText = "", 3000);
});
</script>

</body>
</html>
