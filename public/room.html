<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Room Curhat</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">

  <a href="index.html" class="btn btn-sm btn-secondary mb-3">â† Kembali</a>

  <h4 id="judulRoom"></h4>
  <p id="online" class="text-muted"></p>

  <div class="mt-3">
    <input id="emailSub" class="form-control mb-2" placeholder="Email untuk notifikasi" />
    <button class="btn btn-warning" onclick="subscribe()">Subscribe</button>
  </div>


  <div id="kotakChat" class="border rounded p-3 mb-2 bg-white" style="height:300px; overflow-y:auto;"></div>
  <p id="indikatorMengetik" class="text-muted fst-italic"></p>

  <div class="input-group">
    <input id="inputPesan" class="form-control" placeholder="Tulis pesan..." />
    <button class="btn btn-primary" onclick="kirim()">Kirim</button>
  </div>

</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io("http://localhost:3000");

const params = new URLSearchParams(window.location.search);
const postId = params.get("postId");
const judul = decodeURIComponent(params.get("judul"));

document.getElementById("judulRoom").innerText = judul;

const clientId =
  sessionStorage.getItem("client_id") || crypto.randomUUID();
sessionStorage.setItem("client_id", clientId);

socket.on("connect", () => {
  socket.emit("daftar_user", { client_id: clientId });
  socket.emit("masuk_post", { postId });
});

socket.on("user_online", d => {
  document.getElementById("online").innerText =
    "User online: " + d.jumlah;
});

const chatBox = document.getElementById("kotakChat");
const indikator = document.getElementById("indikatorMengetik");
const input = document.getElementById("inputPesan");

function tampilkan(teks) {
  const p = document.createElement("div");
  p.innerText = teks;
  chatBox.appendChild(p);
  chatBox.scrollTop = chatBox.scrollHeight;
}

socket.on("riwayat_pesan", (list) => {
  chatBox.innerHTML = "";
  list.forEach(p => tampilkan(`${p.pengirimAnonim}: ${p.isi}`));
});

socket.on("pesan_baru", d => tampilkan(`${d.dari}: ${d.isi}`));

function kirim() {
  const isi = input.value.trim();
  if (!isi) return;
  socket.emit("kirim_pesan", {
    postId,
    isi_pesan: isi,
    emailPengirim: emailSaya
  });
  socket.emit("berhenti_mengetik", { postId });
  input.value = "";
}

/* typing */
let typing = false;
let tmr = null;

input.addEventListener("input", () => {
  if (!typing) {
    typing = true;
    socket.emit("mulai_mengetik", { postId });
  }
  clearTimeout(tmr);
  tmr = setTimeout(() => {
    typing = false;
    socket.emit("berhenti_mengetik", { postId });
  }, 1000);
});

socket.on("user_mengetik", d => indikator.innerText = d.pesan);
socket.on("user_berhenti_mengetik", () => indikator.innerText = "");




let emailSaya = null;

function subscribe() {
  emailSaya = document.getElementById("emailSub").value.trim();
  if (!emailSaya) return alert("Isi email");

  socket.emit("subscribe_post", {
    postId,
    email: emailSaya
  });
}


socket.on("subscribe_berhasil", d => alert(d.pesan));
socket.on("subscribe_gagal", d => alert(d.pesan));

</script>

</body>
</html>
